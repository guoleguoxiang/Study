要实现应用程序之间的交互，我们需要一个能够在浏览器和web服务器之间传递请求和响应（都是0和1组成的数字信息）的机制，这个过程也叫做通信，在通信的过程中要确定通信对象，并把请求和响应发送给他们（确保不会丢失和损坏）。它们的基本思路是把数字信息分割成一个一个的小块，装入“包”容器中来运送。

# 1 浏览器生成消息--探索浏览器内部

![image-20231221144942232](C:\Users\19851\AppData\Roaming\Typora\typora-user-images\image-20231221144942232.png)

## 1.1 生成HTTP请求信息

### 1.1.1 探索之旅从输入网址开始

### 1.1.2 浏览器先要解析URL

### 1.1.3 省略文件名的情况

### 1.1.4 HTTP的基本思路

### 1.1.5 生成HTTP请求信息

### 1.1.6 发送请求后会受到响应



## 1.2 向DNS服务器查询Web服务器的IP地址

### 1.2.1 IP地址的基本知识

### 1.2.2 域名和IP地址并用的理由

### 1.2.3 Socket库提供查询IP地址的功能

### 1.2.4 通过解析器向DNS服务器发出查询

### 1.2.5 解析器的内部原理 



## 1.3 全世界DNS服务器的大接力

### 1.3.1 DNS服务器的基本工作

### 1.3.2 域名的层次结构

### 1.3.3 寻找相应的DNS服务器并获取IP地址

### 1.3.4 通过缓存加快DNS服务器的响应



## 1.4 委托协议栈发送消息

### 1.4.1 数据收发操作概览

### 1.4.2 创建套接字阶段

### 1.4.3 连接阶段：把管道接上去

### 1.4.4 通信阶段：传递消息

### 1.4.5 断开阶段：收发数据结束



# 2 用电信号传输TCP/IP数据 -- 探索协议栈和网卡

## 2.1 创建套接字

### 2.1.1 协议栈的内部结构

### 2.1.2 套接字的实体就是通信控制信息

### 2.1.3 调用socket时的操作



## 2.2 连接服务器

### 2.2.1 连接是什么意思

### 2.2.2 负责保护控制信息的头部

### 2.2.3 连接操作的实际过程



## 2.3 收发数据

### 2.3.1 将HTTP请求消息交给协议栈

### 2.3.2 对较大的数据进行拆分

### 2.3.3 使用ACK号确认网络包已收到

### 2.3.4 根据网络包平均往返时间调整ACK号等待时间

### 2.3.5 使用窗口有效管理ACK号

### 2.3.6 ACK与窗口的合并

### 2.3.7 接收HTTP响应消息



## 2.4 从服务器断开并删除套接字

### 2.4.1 数据发送完毕后断开连接

### 2.4.2 删除套接字

### 2.4.3 数据收发操作小结



## 2.5 IP与以太网的包收发操作

### 2.5.1 包的基本知识

### 2.5.2 包收发操作概览

### 2.5.3 生成包含接收方IP地址的IP头部

### 2.5.4 生成以太网用的MAC头部

### 2.5.5 通过ARP查询目标路由器的MAC地址

### 2.5.6 以太网的基本知识

### 2.5.7 将IP包转换成电或光信号发送出去

### 2.5.8 给网络包再加3个控制数据

### 2.5.9 向集线器发送网络包

### 2.5.10 接收返回包

### 2.5.11 将服务器的响应包从IP传递给TCP



## 2.6 UDP协议的收发操作

### 2.6.1 不需要重发的数据用UDP发送更高效

### 2.6.2 控制用的短数据

### 2.6.3 音频和视频数据





# 3 从网线到网络设备--探索集线器、交换机和路由器

## 3.1 信号在网线和集线器中传输

### 3.1.1 每个包都是独立传输的

### 3.1.2 防止网线中的信号衰减很重要

### 3.1.3 “双绞”是为了抑制噪声

### 3.1.4 集线器将信号发往所有线路



## 3.2 交换机的包转发操作

### 3.2.1 交换机根据地址表进行转发

**集线器（HUB）：**将网线集中到一起的机器，多台主机和设备的连接器。集线器的主要功能是对接收到的信号进行同步整形和放大，以扩大网络的传输距离（中继器的一种形式）。集线器的基本功能是信息分发，它把一个端口接收的**所有信号**向**所有端口**分发出去。集线器实际上是一种多端口的中继器。

**交换机（Switch）：**交换机也叫交换式集线器，它通过**对信息重新生成，经过内部处理之后转发至指定端口**，具备自动寻址能力和交换作用。由于交换机根据所传递信息包的目的地址，将每一信息包独立地从源端口送至目的端口，避免了和其他端口发生碰撞。广义的交换机就是一种在通信系统中完成信息交换功能的设备。

**路由器（Router）：**路由器构成了基于TCP/IP的国际互连网络Internet的主体脉络。它处于网络层，一方面能够跨越不同的物理网络类型（DDN、FDDI、以太网等），另一方面在逻辑上将整个互连网络分割成逻辑上独立的网络单位，使网络具有一定的逻辑结构。路由器的主要工作就是为经过路由器的每个数据帧寻找一条最佳传输路径，并将该数据有效的传送到目的站点。路由器的基本功能是把数据（IP报文）传送到正确的网络，细分则包括：

1. IP数据报的转发，包括数据报的寻址和传送；
2. 子网隔离，抑制广播风暴
3. 维护路由表，并与其他路由器交换路由信息，这是IP报文转发的基础；
4. IP数据报的差错处理及简单的拥塞控制；
5. 实现对IP数据报的过滤和记账；

路由器构成了 Internet 的骨架。它的处理速度是网络通信的主要瓶颈之一，它的可靠性则直接影响着网络互连的质量。因此Internet 研究领域中，路由器技术始终处于核心地位。

**网桥（Bridge）：**简单的说网桥就是个硬件网络协议翻译器，假设你有2台电脑，一台兼容机安装windows，一台是Apple安装OS2，那么两台电脑之间是默认网络协议是不同的，就好象两个外国人都不会说对方的语言，怎么办？找个翻译，网桥就是翻译。

在386、486时代网桥可能是一台安装了协议转换程序的电脑，如今交换机也包含这个功能。今天的操作系统之间为了互相交流，支持更多的协议，操作系统自己就可以是网桥，现在网桥这个概念已经淡出了。更多是所谓的桥接、转发、协议二次封装。

网桥也可以说相当一个端口少的二层交换机，再者网桥主要由软件实现，交换机主要由硬件实现！

**网关（Gateway）：**按照不同的分类标准，网关也有很多种。TCP/IP协议里的网关是最常用的，在这里我们通常所讲的“网关”均指TCP/IP协议下的网关。

**网关实质上是一个网络通向其他网络的IP地址**。比如有网络A和网络B，网络A的IP地址范围为“192.168.1.1~192. 168.1.254”，子网掩码为255.255.255.0；网络B的IP地址范围为“192.168.2.1~192.168.2.254”，子网掩码为255.255.255.0。在没有路由器的情况下，两个网络之间是不能进行TCP/IP通信的，即使是两个网络连接在同一台交换机(或集线器)上，TCP/IP协议也会根据子网掩码(255.255.255.0)判定两个网络中的主机处在不同的网络里。而**要实现这两个网络之间的通信，则必须通过网关**。**如果网络A中的主机发现数据包的目的主机不在本地网络中，就把数据包转发给它自己的网关，再由网关转发给网络B的网关，网络B的网关再转发给网络B的某个主机**。

所以说，**只有设置好网关的IP地址，TCP/IP协议才能实现不同网络之间的相互通信**。那么这个IP地址是哪台机器的IP地址呢？**网关的IP地址是具有路由功能的设备的IP地址**，具有路由功能的设备有路由器、启用了路由协议的服务器(实质上相当于一台路由器)、代理服务器(也相当于一台路由器)。

### 3.2.2 MAC地址表的维护

### 3.2.3 特殊操作

### 3.2.4 全双工模式可以同时进行发送和接收

### 3.2.5 自动协商：确定最优的传输速率

### 3.2.6 交换机可同时执行多个转发操作



## 3.3 路由器的包转发操作

### 3.3.1 路由器的基本知识

### 3.3.2 路由表中的信息

### 3.3.3 路由器的包接收操作

### 3.3.4 查询路由表确定输出端口

### 3.3.5 找不到匹配路由时选择默认路由

**默认路由：**
默认路由是计算机网络中的一个重要概念，它用于指定在没有更特定路由匹配的情况下，数据包应该被发送到的下一跳路由器。默认路由通常被称为 "0.0.0.0/0"，表示匹配所有目标 IP 地址。

当一个路由器或计算机试图发送数据包到目标地址时，它会检查路由表以确定应该使用哪个出口接口或下一跳路由器。如果在路由表中找不到与目标地址匹配的特定路由条目，那么就会使用默认路由。

### 3.3.6 包的有效期

### 3.3.7 通过分片功能拆分大网络包

**路由器中的分片功能和TCP拆分数据有什么区别？**

**路由器中的分片功能：**发生在**网络层**。在网络层，当一个 IP 数据包太大而无法在传输过程中的某个链路上进行传输时，路由器可能会对其进行分片。这是因为不同的链路可能有不同的最大传输单元（MTU）。分片将大的数据包分成更小的片段，以适应链路的 MTU。每个分片都是一个独立的 IP 数据包，具有自己的 IP 头信息。

**TCP协议中的数据分段：**发生在**传输层**。TCP 协议负责将应用层的数据流分割成一系列的数据段（segments）。这个过程称为数据分段，而每个数据段包含了 TCP 头部信息以及应用层数据的一部分。这样的分段可以通过网络传输到目的地，然后在接收端重新组装成完整的数据流。**TCP 的数据分段是为了管理传输层的数据流，并在数据流传输的过程中提供可靠性和流控制。每个数据段都有序号和确认号，以确保数据的正确接收和按序传递。**

### 3.3.8 路由器的发送操作和计算机相同

### 3.3.9 路由器与交换机的关系

计算机在发送网络包时，或者路由器在转发网络包时，都需要在前面加上MAC头部。之前的讲解都是说在开头加上MAC头部，准确的说法是将IP包装进以太网包的数据部分中。也就是说，给包加上MAC头部并发送，从本质上说是将IP包装进以太网包的数据部分中，委托以太网去传输这些数据。IP协议本身没有传输包的功能，因此包的实际传输要委托以太网来进行。路由器是基于IP设计的，交换机基于以太网设计的，因此IP与以太网的关系也就是路由器和交换的关系。换句话说，路由器将包的传输工作委托给交换机来进行。

以上内容只适用与纯粹的路由器和纯粹的交换机。目前的家用路由器里面有内置交换机功能，不使用上面所说的理论。 



## 3.4 路由器的附加功能

### 3.4.1 通过地址转换有效利用IP地址

### 3.4.2 地址转换的基本原理

### 3.4.3 改写端口号的原因

### 3.4.4 从互联网访问公司内网

### 3.4.5 路由器的包过滤功能





# 4 通过接入网进入互联网内部 -- 探索接入网和网络运营商

## 4.1 ADSL接入网的结构和工作方式

## 4.2 光纤接入网（FTTH）

## 4.3 接入网中使用的PPP和隧道

## 4.4 网络运营商的内部

## 4.5 跨越运营商的网络包



# 5 服务器端的局域网中有什么玄机

## 5.1 Web服务器的部署地点

## 5.2 防火墙的结构和原理

## 5.3 通过将请求平均分配给多台服务器来平衡负载

## 5.4 使用缓存服务器分担负载

## 5.5 内容分发服务



# 6 请求到达Web服务器，响应返回浏览器 -- 短短几秒的“漫长旅程”迎来终点

## 6.1 服务器概览

## 6.2 服务器的接收操作

## 6.3 Web服务器程序解释请求消息并做出响应

## 6.4 浏览器接受响应消息并显示内容





**调制解调器（Modem）：**用于在数字设备（计算机）和模拟信号传输媒介（电话或电缆）之间进行数字信号的调制和解调的设备。

1. **数字信号转模拟信号（调制）：**当数字设备（例如计算机）需要通过模拟信号传输数据时，调制解调器将数字信号转换为模拟信号，以适应传输媒介的特性，例如电话线。这个过程称为调制。
2. **模拟信号转数字信号（解调）：** 当从模拟信号传输媒介接收到数据时，调制解调器执行解调过程，将模拟信号转换回数字信号。这个数字信号可以被数字设备（例如计算机）正确地理解和处理。



**Asynchronous Transfer Mode（异步传输模式）：** ATM 是一种网络传输技术，其基本思想是将数据切割成固定大小的小单元，称为“单元”（cell），每个单元包含 53 个字节。ATM 是一种面向连接的、异步传输的技术，适用于传输各种类型的数据，包括语音、视频和数据。ATM 技术曾在一段时间内被认为是一种高带宽、低延迟的传输技术，但随着其他技术的发展，如以太网和光纤通信，ATM 的应用逐渐减少。

异步传输与同步传输：

**缓存服务器：**缓存服务器的应用模式主要是**正向代理**和**反向代理**，正向代理的工作原理是客户端将要直接发送到internet上源服务器的连接请求发送给代理服务器处理；反向代理的工作原理是将用户的请求和应用服务器应答的内容写入缓存服务器中，为后续用户的访问提供更快的响应。

CDN缓存服务器（CDN：内容分发网络）：CDN的基本原理是**广泛采用各种缓存服务器，将缓存服务器分布到用户访问相对集中的地区或网络中，在用户访问网站时，利用全局负载技术将用户的访问指向距离最近的工作正常的缓存服务器上，由缓存服务器直接响应用户请求**。 CDN主要解决将数据缓存到离用户最近的位置，一般缓存静态资源文件（页面，脚本，图片，视频，文件等）。

**反向代理缓存服务器：** **反向代理**位于web服务器端，客户端向web服务器请求信息，实际上是向反向代理服务器请求信息，反向代理看自己缓存中是否有该信息，若有直接发送给用户。若没有，则反向代理服务器向web服务器发出请求信息（与客户端直接向web服务器请求信息很像，有一些区别，如反向代理服务器向web服务器请求的信息中是一个完整的url等等），将接收到的响应信息进行缓存后，发送给用户。通过反向代理可以降低向web服务器的请求次数，达到降低web服务器负载的作用。**反向代理常用于提供负载均衡、安全性、加速和简化客户端访问。它可以隐藏后端服务器的真实结构，提供统一的入口点，同时通过负载均衡来分发请求，确保高可用性。**

正向代理缓存服务器：正向代理是代理服务器位于客户端和目标服务器之间，代理服务器**代表客户端**向目标服务器请求资源。当客户端请求访问互联网上的资源时，它将请求发送到正向代理服务器，然后代理服务器将请求转发给目标服务器，并将从目标服务器获取的响应再转发给客户端。从目标服务器的角度来看，请求似乎是由代理服务器发起的，而不是真实的客户端。**正向代理通常用于增强客户端的隐私和安全性，以及绕过一些访问限制**。例如，在企业环境中，员工可能通过正向代理访问互联网，而代理服务器负责过滤和审查流量，提供匿名性。

**分布式缓存服务器（memecache）：**CDN,反向代理缓存，主要解决静态文件，或用户请求资源的缓存，数据源一般为静态文件或动态生成的文件（有缓存头标识）。分布式缓存，**主要指缓存用户经常访问数据的缓存，数据源为数据库**。一般起到热点数据访问和减轻数据库压力的作用。目前分布式缓存设计，在大型网站架构中是必备的架构要素。**常用的中间件有Memcache，Redis。**



负载均衡器：可以充当流量指挥官，它位于服务器的前面，负责将客户端请求路由到所有能够满足这些请求的服务器，同时最大限度地提高速度和容量利用率，并确保无任何服务器过载。若某台服务器发生故障，则负载均衡器会将流量重定向到其余的在线服务器。在将新服务器添加到服务器组后，负载均衡器会自动向该服务器发送请求。

负载均衡器的功能：

- 在多台服务器之间高效分配客户端请求或网络负载
- 仅向在线服务器发送请求，确保高可用性和可靠性
- 提供按需增减服务器的灵活性

![load balancing diagram](https://www.nginx-cn.net/wp-content/uploads/2014/07/what-is-load-balancing-diagram-NGINX-640x324-1.png)

负载均衡算法：

不同的负载均衡算法可提供不同的优势；负载均衡方法的选择取决于您的需求：

- **轮询调度** —— 将请求按顺序分发到服务器组。
- **最少连接** —— 将新请求发送到当前客户端连接数最少的服务器。根据每台服务器的相对计算能力，确定哪台服务器的客户端连接数最少。
- **最短时间** —— 将请求发送到通过公式选择的（结合最快响应时间和最少活动连接数）服务器。此为 NGINX Plus 独有功能。
- **哈希** —— 根据您定义的密钥分发请求，例如客户端 IP 地址或请求 URL。NGINX Plus 可以选择应用一致的哈希，以在上游服务器组发生变化时最大限度减少负载的重新分配。
- **IP 哈希** —— 使用客户端的 IP 地址确定哪台服务器接收请求。
- **两次随机选择** —— 随机选择两台服务器，然后将请求发送到通过应用最少连接算法（或者如果配置了 NGINX Plus，可采用最短时间算法）所选择的服务器。

浅谈几种常用负载均衡框架：https://www.51cto.com/article/595761.html